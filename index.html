<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeskFit - Your Micro-Habit Tracker</title>

    <!-- FARCASTER META TAGS -->
    <meta property="fc:frame" content="vNext" />
    <meta property="fc:frame:image" content="https://i.imgur.com/uR3JATB.png" />
    <meta property="og:image" content="https://i.imgur.com/uR3JATB.png" />
    <meta property="fc:frame:button:1" content="Start Your Micro-Habits" />
    <meta property="og:title" content="DeskFit - Your Micro-Habit Tracker" />

    <!-- Farcaster JS SDK -->
    <script src="https://farcaster.dev/js/index.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; background: linear-gradient(to bottom right, #e0f2f7, #c1e4f4); color: #333; text-align: center; }
        .app-container { background-color: #ffffff; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); padding: 40px; max-width: 400px; width: 90%; display: flex; flex-direction: column; gap: 20px; }
        h1 { color: #2c3e50; margin-bottom: 5px; font-size: 2.2em; }
        p.tagline { color: #7f8c8d; font-size: 1.1em; margin-top: 0; margin-bottom: 20px; }
        .task-display { background-color: #f8f8f8; border: 1px solid #dcdcdc; border-radius: 10px; padding: 25px 20px; min-height: 100px; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 1.4em; font-weight: 600; color: #34495e; transition: background-color 0.3s ease, transform 0.3s ease; }
        .task-display.new-task { animation: fadeInScale 0.5s ease-out; }
        .task-text { margin-bottom: 10px; }
        .xp-text { font-size: 0.9em; color: #27ae60; font-weight: 700; display: flex; align-items: center; gap: 5px; }
        .xp-text::before { content: '‚ú®'; font-size: 1.2em; }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .buttons-container { display: flex; gap: 15px; width: 100%; justify-content: center; }
        button { background-color: #3498db; color: white; border: none; border-radius: 8px; padding: 15px 25px; font-size: 1.2em; cursor: pointer; transition: background-color 0.3s ease, transform 0.1s ease; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4); flex: 1; min-width: 120px; }
        button.complete { background-color: #2ecc71; box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4); }
        button.complete:hover { background-color: #27ae60; }
        button.skip { background-color: #e74c3c; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4); }
        button.skip:hover { background-color: #c0392b; }
        button:hover { transform: translateY(-2px); }
        button:active { transform: translateY(0); box-shadow: 0 2px 10px rgba(52, 152, 219, 0.4); }
        .stats-container { display: flex; justify-content: space-around; margin-top: 10px; }
        .total-xp-display, .streak-display { font-size: 1.1em; font-weight: 600; color: #2c3e50; display: flex; align-items: center; gap: 8px; }
        .total-xp-display::before { content: '‚≠ê'; font-size: 1.3em; }
        .streak-display::before { content: 'üî•'; font-size: 1.3em; }
        .share-button { margin-top: 15px; background-color: #8e44ad; font-size: 1em; padding: 10px 20px; box-shadow: 0 4px 15px rgba(142, 68, 173, 0.4); display: none; }
        .share-button:hover { background-color: #732d91; }
    </style>
</head>
<body>
    <div class="app-container">
        <h1>DeskFit</h1>
        <p class="tagline">Fitness for your desk life. Small moves, mindful days.</p>
        <div id="taskDisplay" class="task-display">
            <div class="task-text">Click "Get Task" to start your journey!</div>
            <div class="xp-text" id="currentTaskXP"></div>
        </div>
        <div class="buttons-container">
            <button id="completeTaskButton" class="complete" style="display:none;">Complete Task</button>
            <button id="skipTaskButton" class="skip" style="display:none;">Skip Task</button>
            <button id="getNewTaskButton">Get Task</button>
        </div>
        <div class="stats-container">
            <div id="totalXPDisplay" class="total-xp-display"><span id="xpValue">0</span> XP</div>
            <div id="streakDisplay" class="streak-display"><span id="streakValue">0</span> Streak</div>
        </div>
        <button id="shareProgressButton" class="share-button">Share Progress</button>
    </div>

    <script>
        // Use DOMContentLoaded which fires when the HTML document is fully parsed,
        // which is more reliable than 'load'.
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- DOM ELEMENTS ---
            const getNewTaskButton = document.getElementById('getNewTaskButton');
            const completeTaskButton = document.getElementById('completeTaskButton');
            const skipTaskButton = document.getElementById('skipTaskButton');
            const shareProgressButton = document.getElementById('shareProgressButton');
            const taskDisplay = document.getElementById('taskDisplay');
            const taskTextElement = taskDisplay.querySelector('.task-text');
            const currentTaskXPElement = document.getElementById('currentTaskXP');
            const totalXPDisplay = document.getElementById('xpValue');
            const streakDisplay = document.getElementById('streakValue');

            // --- APP STATE ---
            let totalXP = 0;
            let streak = 0;
            let currentTask = null;
            let farcasterUserFid = null; // Will store the user's Farcaster ID

            // A smaller task list for cleaner code. You can paste your full list back in.
            const tasks = [ { text: "Stand for 10 minutes", xp: 15 }, { text: "Take 3 floors with stairs", xp: 20 }, { text: "Skip snacks for today", xp: 25 }, { text: "Drink a glass of water", xp: 10 }, { text: "Stretch your arms overhead", xp: 10 }, { text: "Do 10 squats", xp: 20 }, { text: "Walk while on a call", xp: 15 }, { text: "Do a wall sit for 30 seconds", xp: 20 }];

            // --- DATA PERSISTENCE ---
            const getStorageKey = (key) => farcasterUserFid ? `deskfit_${key}_${farcasterUserFid}` : `deskfit_${key}_local`;

            const loadState = () => {
                try {
                    const savedXP = localStorage.getItem(getStorageKey('totalXP'));
                    const savedStreak = localStorage.getItem(getStorageKey('streak'));
                    totalXP = savedXP ? parseInt(savedXP, 10) : 0;
                    streak = savedStreak ? parseInt(savedStreak, 10) : 0;
                    updateDisplays();
                } catch (e) {
                    console.error("Failed to load state from localStorage:", e);
                }
            };

            const saveState = () => {
                try {
                    localStorage.setItem(getStorageKey('totalXP'), totalXP);
                    localStorage.setItem(getStorageKey('streak'), streak);
                } catch (e) {
                    console.error("Failed to save state to localStorage:", e);
                }
            };

            // --- UI & CORE LOGIC ---
            const updateDisplays = () => {
                totalXPDisplay.textContent = totalXP;
                streakDisplay.textContent = streak;
            };

            const showTaskActionButtons = (show) => {
                completeTaskButton.style.display = show ? 'block' : 'none';
                skipTaskButton.style.display = show ? 'block' : 'none';
                getNewTaskButton.style.display = show ? 'none' : 'block';
            };

            const getNewTask = () => {
                const randomIndex = Math.floor(Math.random() * tasks.length);
                currentTask = tasks[randomIndex];
                taskDisplay.classList.remove('new-task');
                void taskDisplay.offsetWidth; // Force reflow for animation
                taskTextElement.textContent = currentTask.text;
                currentTaskXPElement.textContent = `${currentTask.xp} XP`;
                taskDisplay.classList.add('new-task');
                showTaskActionButtons(true);
            };

            const completeTask = () => {
                if (!currentTask) return;
                totalXP += currentTask.xp;
                streak++;
                saveState();
                updateDisplays();
                currentTask = null;
                taskTextElement.textContent = "Great job! Get another task.";
                currentTaskXPElement.textContent = "";
                showTaskActionButtons(false);
            };

            const skipTask = () => {
                if (!currentTask) return;
                streak = 0; // Reset streak
                saveState();
                updateDisplays();
                currentTask = null;
                taskTextElement.textContent = "Task skipped. Try another one!";
                currentTaskXPElement.textContent = "";
                showTaskActionButtons(false);
            };

            const shareToFarcaster = async () => {
                const castText = `I just hit ${totalXP} XP with a ${streak}-day streak on DeskFit! üí™ #deskfit`;
                try {
                    await Farcaster.actions.cast({ text: castText, embeds: [{ url: window.location.href }] });
                } catch (error) {
                    console.error("Farcaster cast action failed:", error);
                    alert("Could not open Farcaster to share.");
                }
            };
            
            // --- FARCASTER INTEGRATION ---
            const initializeFarcaster = async () => {
                // This is the MOST IMPORTANT part for the "Ready not called" error.
                // We call ready() immediately.
                if (Farcaster.actions) {
                    console.log("Farcaster SDK detected. Calling ready().");
                    Farcaster.actions.ready();
                }

                try {
                    const user = await Farcaster.getUser();
                    if (user && user.status === 'approved') {
                        farcasterUserFid = user.fid;
                        console.log("Farcaster user approved. FID:", farcasterUserFid);
                        shareProgressButton.style.display = 'block'; // Show share button
                        
                        // IMPORTANT: Re-load state now that we have the FID
                        loadState();
                    }
                } catch (error) {
                    console.error("Error getting Farcaster user:", error);
                }
            };


            // --- APP INITIALIZATION ---
            const initializeApp = () => {
                console.log("Initializing DeskFit App...");
                // Set up event listeners for core app functionality
                getNewTaskButton.addEventListener('click', getNewTask);
                completeTaskButton.addEventListener('click', completeTask);
                skipTaskButton.addEventListener('click', skipTask);
                shareProgressButton.addEventListener('click', shareToFarcaster);
                
                // Load the initial state (for non-Farcaster users or before FID is known)
                loadState();
                showTaskActionButtons(false);
                
                // Check for Farcaster environment and enhance the app if present
                if (typeof Farcaster !== 'undefined') {
                    initializeFarcaster();
                } else {
                    console.log("Not in a Farcaster client environment.");
                }
            };

            // Start the application!
            initializeApp();
        });
    </script>
</body>
</html>
