<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeskFit - Your Micro-Habit Tracker</title>

    <!-- 
      FARCASTER META TAGS (ESSENTIAL)
      These tags create the "frame" that appears in the Farcaster feed.
      Replace the image URL with a direct link to an image you host.
      Good image dimensions are 1.91:1 ratio (e.g., 1200x628 pixels).
    -->
    <meta property="fc:frame" content="vNext" />
    <meta property="fc:frame:image" content="https://i.imgur.com/uR3JATB.png" /> 
    <meta property="og:image" content="https://i.imgur.com/uR3JATB.png" />
    <meta property="fc:frame:button:1" content="Start Your Micro-Habits" />
    <meta property="og:title" content="DeskFit - Your Micro-Habit Tracker" />

    <!-- Farcaster JS SDK -->
    <script src="https://farcaster.dev/js/index.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(to bottom right, #e0f2f7, #c1e4f4);
            color: #333;
            text-align: center;
        }

        .app-container {
            background-color: #ffffff;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 40px;
            max-width: 400px;
            width: 90%;
            display: flex;
            flex-direction: column;
            gap: 20px; /* Adjusted gap */
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 5px; /* Adjusted margin */
            font-size: 2.2em;
        }

        p.tagline {
            color: #7f8c8d;
            font-size: 1.1em;
            margin-top: 0;
            margin-bottom: 20px; /* Adjusted margin */
        }

        .task-display {
            background-color: #f8f8f8;
            border: 1px solid #dcdcdc;
            border-radius: 10px;
            padding: 25px 20px;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 1.4em;
            font-weight: 600;
            color: #34495e;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }

        .task-display.new-task {
            animation: fadeInScale 0.5s ease-out;
        }

        .task-text {
            margin-bottom: 10px;
        }

        .xp-text {
            font-size: 0.9em;
            color: #27ae60;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .xp-text::before {
            content: '‚ú®';
            font-size: 1.2em;
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .buttons-container {
            display: flex;
            gap: 15px;
            width: 100%;
            justify-content: center;
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 15px 25px;
            font-size: 1.2em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
            flex: 1;
            min-width: 120px;
        }

        button.complete {
            background-color: #2ecc71;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4);
        }
        button.complete:hover { background-color: #27ae60; }

        button.skip {
            background-color: #e74c3c;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
        }
        button.skip:hover { background-color: #c0392b; }

        button:hover { transform: translateY(-2px); }
        button:active { transform: translateY(0); box-shadow: 0 2px 10px rgba(52, 152, 219, 0.4); }

        .stats-container {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
        }

        .total-xp-display, .streak-display {
            font-size: 1.1em;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .total-xp-display::before { content: '‚≠ê'; font-size: 1.3em; }
        .streak-display::before { content: 'üî•'; font-size: 1.3em; }

        .share-button {
            margin-top: 15px;
            background-color: #8e44ad; /* Farcaster Purple */
            font-size: 1em;
            padding: 10px 20px;
            box-shadow: 0 4px 15px rgba(142, 68, 173, 0.4);
            display: none; /* Hidden by default */
        }
        .share-button:hover { background-color: #732d91; }
    </style>
</head>
<body>
    <div class="app-container">
        <h1>DeskFit</h1>
        <p class="tagline">Fitness for your desk life. Small moves, mindful days.</p>

        <div id="taskDisplay" class="task-display">
            <div class="task-text">Click "Get Task" to start your micro-habit journey!</div>
            <div class="xp-text" id="currentTaskXP"></div>
        </div>

        <div class="buttons-container">
            <button id="completeTaskButton" class="complete" style="display:none;">Complete Task</button>
            <button id="skipTaskButton" class="skip" style="display:none;">Skip Task</button>
            <button id="getNewTaskButton">Get Task</button>
        </div>

        <div class="stats-container">
            <div id="totalXPDisplay" class="total-xp-display">
                <span id="xpValue">0</span> XP
            </div>
            <div id="streakDisplay" class="streak-display">
                <span id="streakValue">0</span> Streak
            </div>
        </div>

        <button id="shareProgressButton" class="share-button">Share Progress</button>
    </div>

    <script>
    window.addEventListener('load', () => {
        // --- DOM ELEMENTS ---
        const getNewTaskButton = document.getElementById('getNewTaskButton');
        const completeTaskButton = document.getElementById('completeTaskButton');
        const skipTaskButton = document.getElementById('skipTaskButton');
        const shareProgressButton = document.getElementById('shareProgressButton');
        const taskDisplay = document.getElementById('taskDisplay');
        const taskTextElement = taskDisplay.querySelector('.task-text');
        const currentTaskXPElement = document.getElementById('currentTaskXP');
        const totalXPDisplay = document.getElementById('xpValue');
        const streakDisplay = document.getElementById('streakValue');

        // --- APP STATE ---
        let totalXP = 0;
        let streak = 0;
        let currentTask = null;
        let farcasterUserFid = null;

        const tasks = [ { text: "Stand for 10 minutes", xp: 15 }, { text: "Take 3 floors with stairs", xp: 20 }, { text: "Skip snacks for today", xp: 25 }, { text: "Drink a glass of water", xp: 10 }, { text: "Stretch your arms overhead", xp: 10 }, { text: "Roll your shoulders backward 10 times", xp: 10 }, { text: "Walk one lap around the room", xp: 15 }, { text: "Walk while on a call", xp: 15 }, { text: "Do 10 squats", xp: 20 }, { text: "Touch your toes 10 times", xp: 15 }, { text: "Refill your water bottle", xp: 10 }, { text: "Do calf raises for 30 seconds", xp: 15 }, { text: "Walk to a colleague instead of messaging", xp: 20 }, { text: "Stand during your next meeting", xp: 15 }, { text: "March in place for 1 minute", xp: 15 }, { text: "Do a 2 minute stretch break", xp: 10 }, { text: "Take a short walk after lunch", xp: 20 }, { text: "Stand on one leg for 20 seconds per side", xp: 15 }, { text: "Do a wall sit for 30 seconds", xp: 20 }, { text: "Straighten your posture for 1 minute", xp: 10 }];

        // --- DATA PERSISTENCE FUNCTIONS ---
        function getStorageKey(key) {
            return farcasterUserFid ? `deskfit_${key}_${farcasterUserFid}` : `deskfit_${key}_local`;
        }

        function loadState() {
            const savedXP = localStorage.getItem(getStorageKey('totalXP'));
            const savedStreak = localStorage.getItem(getStorageKey('streak'));
            totalXP = savedXP ? parseInt(savedXP, 10) : 0;
            streak = savedStreak ? parseInt(savedStreak, 10) : 0;
            console.log(`State loaded for user ${farcasterUserFid || 'local'}: XP=${totalXP}, Streak=${streak}`);
            updateDisplays();
        }

        function saveState() {
            localStorage.setItem(getStorageKey('totalXP'), totalXP);
            localStorage.setItem(getStorageKey('streak'), streak);
            console.log(`State saved for user ${farcasterUserFid || 'local'}`);
        }

        // --- UI UPDATE FUNCTIONS ---
        function updateDisplays() {
            totalXPDisplay.textContent = totalXP;
            streakDisplay.textContent = streak;
        }

        function showTaskActionButtons(show) {
            completeTaskButton.style.display = show ? 'block' : 'none';
            skipTaskButton.style.display = show ? 'block' : 'none';
            getNewTaskButton.style.display = show ? 'none' : 'block';
        }

        // --- CORE APP LOGIC ---
        function getNewTask() {
            const randomIndex = Math.floor(Math.random() * tasks.length);
            currentTask = tasks[randomIndex];
            taskDisplay.classList.remove('new-task');
            void taskDisplay.offsetWidth;
            taskTextElement.textContent = currentTask.text;
            currentTaskXPElement.textContent = `${currentTask.xp} XP`;
            taskDisplay.classList.add('new-task');
            showTaskActionButtons(true);
        }

        function completeTask() {
            if (!currentTask) return;
            totalXP += currentTask.xp;
            streak++;
            updateDisplays();
            saveState();
            currentTask = null;
            taskTextElement.textContent = "Great job! Get a new task.";
            currentTaskXPElement.textContent = "";
            showTaskActionButtons(false);
        }

        function skipTask() {
            if (!currentTask) return;
            streak = 0;
            updateDisplays();
            saveState();
            currentTask = null;
            taskTextElement.textContent = "Task skipped. Try another one!";
            currentTaskXPElement.textContent = "";
            showTaskActionButtons(false);
        }
        
        async function shareToFarcaster() {
            const castText = `I just earned ${totalXP} XP with a ${streak}-day streak on DeskFit! Feeling good üí™ #deskfit`;
            try {
                await Farcaster.actions.cast({
                    text: castText,
                    embeds: [{ url: window.location.href }]
                });
            } catch (error) {
                console.error("Farcaster cast action failed:", error);
                alert("Could not open Farcaster to share.");
            }
        }

        // --- MAIN INITIALIZATION FUNCTION ---
        async function initializeApp() {
            console.log("App window loaded. Initializing...");

            // THE FIX: Call ready() as soon as the Farcaster object is available.
            // This tells the client to remove the loading screen immediately.
            if (typeof Farcaster !== 'undefined' && Farcaster.actions) {
                console.log("Farcaster object found. Calling Farcaster.actions.ready().");
                Farcaster.actions.ready();
                console.log("Farcaster.actions.ready() has been called.");
            } else {
                console.log("Not in a Farcaster client environment. Farcaster.actions.ready() will not be called.");
            }

            // Now, continue with the rest of the Farcaster-specific setup.
            // This part can happen after the app is already visible to the user.
            if (typeof Farcaster !== 'undefined' && Farcaster.getUser) {
                try {
                    const user = await Farcaster.getUser();
                    if (user && user.status === 'approved') {
                        farcasterUserFid = user.fid;
                        console.log("Farcaster user approved. FID:", farcasterUserFid);
                        shareProgressButton.style.display = 'block';
                    } else {
                        console.log("Farcaster user not approved or not found.");
                    }
                } catch (error) {
                    console.error("Error getting Farcaster user:", error);
                }
            }

            // Load state (which now correctly uses the FID if available) and set up UI
            loadState();
            showTaskActionButtons(false);

            // Add all event listeners
            getNewTaskButton.addEventListener('click', getNewTask);
            completeTaskButton.addEventListener('click', completeTask);
            skipTaskButton.addEventListener('click', skipTask);
            shareProgressButton.addEventListener('click', shareToFarcaster);
        }

        // Start the app!
        initializeApp();
    });
</script>
</body>
</html>
