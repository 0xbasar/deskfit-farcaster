<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeskFit - Your Micro-Habit Tracker</title>
    
    <!-- Farcaster SDK -->
    <script src="https://farcaster.dev/js/index.js"></script>

    <style>
        /* (all your CSS unchanged) */
    </style>
</head>
<body>
    <div class="app-container">
        <h1>DeskFit</h1>
        <p class="tagline">Fitness for your desk life. Small moves, mindful days</p>

        <div id="taskDisplay" class="task-display">
            <div class="task-text">Click "Get a New Task" to start your micro-habit journey!</div>
            <div class="xp-text" id="currentTaskXP"></div>
        </div>

        <div class="buttons-container">
            <button id="completeTaskButton" class="complete" style="display:none;">Complete Task</button>
            <button id="skipTaskButton" class="skip" style="display:none;">Skip Task</button>
            <button id="getNewTaskButton">Get a New Task</button>
        </div>

        <div id="totalXPDisplay" class="total-xp-display">
            Total XP: <span id="xpValue">0</span>
        </div>
        <div id="streakDisplay" class="streak-display">
            Streak: <span id="streakValue">0</span>
        </div>
    </div>

    <script>
        window.addEventListener('load', () => {
            const tasks = [ /* all your task data unchanged */ ];

            const getNewTaskButton = document.getElementById('getNewTaskButton');
            const completeTaskButton = document.getElementById('completeTaskButton');
            const skipTaskButton = document.getElementById('skipTaskButton');
            const taskDisplay = document.getElementById('taskDisplay');
            const taskTextElement = taskDisplay.querySelector('.task-text');
            const currentTaskXPElement = document.getElementById('currentTaskXP');
            const totalXPDisplay = document.getElementById('xpValue');
            const streakDisplay = document.getElementById('streakValue');

            let totalXP = 0;
            let streak = 0;
            let currentTask = null;

            function loadState() {
                const savedXP = localStorage.getItem('deskfit_totalXP');
                const savedStreak = localStorage.getItem('deskfit_streak');
                if (savedXP !== null) totalXP = parseInt(savedXP, 10);
                if (savedStreak !== null) streak = parseInt(savedStreak, 10);
            }

            function saveState() {
                localStorage.setItem('deskfit_totalXP', totalXP);
                localStorage.setItem('deskfit_streak', streak);
            }

            function updateXPDisplay() {
                totalXPDisplay.textContent = totalXP;
            }

            function updateStreakDisplay() {
                streakDisplay.textContent = streak;
            }

            function showTaskActionButtons(show) {
                completeTaskButton.style.display = show ? 'flex' : 'none';
                skipTaskButton.style.display = show ? 'flex' : 'none';
                getNewTaskButton.style.display = show ? 'none' : 'flex';
            }

            function getNewTask() {
                const randomIndex = Math.floor(Math.random() * tasks.length);
                currentTask = tasks[randomIndex];
                taskDisplay.classList.remove('new-task');
                void taskDisplay.offsetWidth;
                taskTextElement.textContent = currentTask.text;
                currentTaskXPElement.textContent = `${currentTask.xp} XP`;
                taskDisplay.classList.add('new-task');
                showTaskActionButtons(true);
            }

            function completeTask() {
                if (currentTask) {
                    totalXP += currentTask.xp;
                    streak++;
                    updateXPDisplay();
                    updateStreakDisplay();
                    saveState();
                    currentTask = null;
                    taskTextElement.textContent = "Great job! Get a new task.";
                    currentTaskXPElement.textContent = "";
                    showTaskActionButtons(false);
                }
            }

            function skipTask() {
                if (currentTask) {
                    streak = 0;
                    updateStreakDisplay();
                    saveState();
                    currentTask = null;
                    taskTextElement.textContent = "Task skipped. Try another one!";
                    currentTaskXPElement.textContent = "";
                    showTaskActionButtons(false);
                }
            }

            // --- App Initialization ---
            getNewTaskButton.addEventListener('click', getNewTask);
            completeTaskButton.addEventListener('click', completeTask);
            skipTaskButton.addEventListener('click', skipTask);

            loadState();
            updateXPDisplay();
            updateStreakDisplay();
            showTaskActionButtons(false);

            // ✅ FIXED: Proper Farcaster SDK ready call
            if (typeof sdk !== 'undefined' && sdk.actions) {
                // Give the SDK a moment to initialize (helps in dev preview)
                setTimeout(() => {
                    sdk.actions.ready();
                    console.log("✅ Farcaster SDK ready called");
                }, 100);
            } else {
                console.warn("⚠️ Farcaster SDK not found");
            }
        });
    </script>
</body>
</html>
